# CODITECT Production Environment - Terraform Variables
# Copy this file to terraform.tfvars and customize values
# DO NOT commit terraform.tfvars to git (contains sensitive data)

# ============================================================================
# GCP Project Configuration
# ============================================================================

project_id = "coditect-production"
project_name = "CODITECT Production"
region = "us-central1"
zone = "us-central1-a"

# Multi-region setup for production
regions = ["us-central1", "us-east1", "us-west1"]

# ============================================================================
# Environment Configuration
# ============================================================================

environment = "production"
labels = {
  environment = "production"
  project     = "coditect"
  managed_by  = "terraform"
  team        = "platform"
  compliance  = "required"
}

# ============================================================================
# GKE Cluster Configuration
# ============================================================================

gke_cluster_name = "coditect-gke-prod"
gke_cluster_version = "1.28"  # Use stable release channel

# Production-grade node pools
gke_node_pools = {
  default = {
    machine_type   = "n2-standard-8"  # 8 vCPU, 32GB RAM
    min_nodes      = 3  # Minimum 3 for HA
    max_nodes      = 50
    disk_size_gb   = 200
    disk_type      = "pd-ssd"
    preemptible    = false  # Never use preemptible in production
    auto_repair    = true
    auto_upgrade   = true
  }
  high_memory = {
    machine_type   = "n2-highmem-8"  # For memory-intensive workloads
    min_nodes      = 0
    max_nodes      = 10
    disk_size_gb   = 200
    disk_type      = "pd-ssd"
    preemptible    = false
    auto_repair    = true
    auto_upgrade   = true
  }
}

gke_enable_private_nodes     = true
gke_enable_private_endpoint  = true  # Secure private cluster
gke_master_ipv4_cidr         = "172.16.0.0/28"
gke_enable_workload_identity = true
gke_enable_vertical_pod_autoscaling = true

# ============================================================================
# Networking Configuration
# ============================================================================

vpc_name = "coditect-vpc-prod"
subnet_name = "gke-subnet-prod"
subnet_cidr = "10.20.0.0/20"

pods_cidr_range = "10.21.0.0/16"
services_cidr_range = "10.22.0.0/16"

db_subnet_name = "db-subnet-prod"
db_subnet_cidr = "10.20.16.0/24"

redis_subnet_name = "redis-subnet-prod"
redis_subnet_cidr = "10.20.17.0/24"

# ============================================================================
# Cloud SQL (PostgreSQL) Configuration
# ============================================================================

cloudsql_instance_name = "coditect-postgres-prod"
cloudsql_database_version = "POSTGRES_15"
cloudsql_tier = "db-custom-16-65536"  # 16 vCPU, 64GB RAM (production scale)
cloudsql_disk_size = 500  # GB, will auto-increase
cloudsql_disk_type = "PD_SSD"
cloudsql_availability_type = "REGIONAL"  # Multi-zone HA

cloudsql_backup_enabled = true
cloudsql_backup_start_time = "03:00"
cloudsql_point_in_time_recovery = true

# Database flags for production optimization
cloudsql_database_flags = [
  {
    name  = "max_connections"
    value = "500"
  },
  {
    name  = "shared_buffers"
    value = "16384"  # 16GB
  }
]

# ============================================================================
# Citus Configuration (for 50K+ tenants)
# ============================================================================

# Citus will be deployed separately via Kubernetes StatefulSets
# This is a placeholder for future Citus migration

enable_citus = false  # Start with standard PostgreSQL
citus_coordinator_instances = 1
citus_worker_instances = 3
citus_shard_count = 32

# ============================================================================
# Redis Configuration
# ============================================================================

redis_instance_name = "coditect-redis-prod"
redis_tier = "STANDARD_HA"  # HA required for production
redis_memory_size_gb = 20  # 20GB for production caching
redis_version = "REDIS_7_0"

# ============================================================================
# Service Accounts
# ============================================================================

terraform_sa_email = "terraform-sa@coditect-production.iam.gserviceaccount.com"
gke_sa_email = "gke-sa@coditect-production.iam.gserviceaccount.com"
django_app_sa_email = "django-app-sa@coditect-production.iam.gserviceaccount.com"

# ============================================================================
# Secrets Configuration
# ============================================================================

secrets = [
  "django-secret-key",
  "db-password",
  "db-readonly-password",
  "stripe-api-key",
  "stripe-webhook-secret",
  "oauth-client-secret",
  "sendgrid-api-key",
  "sentry-dsn"
]

# ============================================================================
# Storage Configuration
# ============================================================================

gcs_buckets = {
  static = {
    name          = "coditect-prod-static"
    location      = "US"
    storage_class = "STANDARD"
    versioning    = true
    lifecycle_rules = [
      {
        action = {
          type = "Delete"
        }
        condition = {
          age = 90  # Delete old versions after 90 days
        }
      }
    ]
  }
  media = {
    name          = "coditect-prod-media"
    location      = "US"
    storage_class = "STANDARD"
    versioning    = true
  }
  backups = {
    name          = "coditect-prod-backups"
    location      = "US"
    storage_class = "NEARLINE"
    versioning    = true
    lifecycle_rules = [
      {
        action = {
          type = "SetStorageClass"
          storage_class = "COLDLINE"
        }
        condition = {
          age = 90  # Move to coldline after 90 days
        }
      }
    ]
  }
}

# ============================================================================
# Monitoring Configuration
# ============================================================================

enable_monitoring = true
enable_logging = true
log_retention_days = 365  # 1 year for production (compliance)

enable_prometheus = true
prometheus_storage_size = "200Gi"  # Large storage for metrics

enable_grafana = true
enable_jaeger = true

# Alert configuration
enable_alerts = true
alert_email = "platform-alerts@coditect.ai"
alert_slack_webhook = ""  # Set in terraform.tfvars

# ============================================================================
# Security Configuration
# ============================================================================

# Restrict SSH to bastion hosts only
allowed_ssh_sources = ["10.0.0.0/8"]

# HTTPS from anywhere (behind Cloud Armor)
allowed_https_sources = ["0.0.0.0/0"]

enable_network_policies = true
enable_binary_authorization = true  # Mandatory for production

# Cloud Armor (DDoS protection)
enable_cloud_armor = true
cloud_armor_rules = [
  {
    description = "Rate limit per IP"
    priority    = 1000
    expression  = "true"
    rate_limit_threshold = 1000  # Requests per minute
  }
]

# ============================================================================
# Cost Management
# ============================================================================

budget_amount = 50000  # USD per month (estimated for 1M tenants)
budget_alert_thresholds = [0.5, 0.75, 0.9, 1.0]

max_nodes_per_zone = 100  # Allow scaling to 100 nodes per zone

# ============================================================================
# Disaster Recovery
# ============================================================================

# Database backups
enable_db_export_to_gcs = true
db_export_schedule = "0 2 * * *"  # Daily at 2 AM
db_export_bucket = "coditect-prod-backups"

# Cross-region replication
enable_cross_region_replication = true
replication_regions = ["us-east1", "us-west1"]

# ============================================================================
# Feature Flags
# ============================================================================

enable_auto_scaling = true
enable_cluster_autoscaling = true
enable_vertical_pod_autoscaling = true
enable_maintenance_window = true

# Maintenance window (Sundays 4-8 AM UTC)
maintenance_window_day = "sunday"
maintenance_window_start_time = "04:00"
maintenance_window_duration = "4h"

# ============================================================================
# Application Configuration
# ============================================================================

django_image_tag = "v1.0.0"  # Use semantic versioning tags
django_replicas = 10  # Start with 10 replicas
django_hpa_min_replicas = 10
django_hpa_max_replicas = 100
django_resources = {
  requests = {
    cpu    = "2000m"
    memory = "4Gi"
  }
  limits = {
    cpu    = "4000m"
    memory = "8Gi"
  }
}

celery_replicas = 5
celery_hpa_min_replicas = 5
celery_hpa_max_replicas = 50
celery_resources = {
  requests = {
    cpu    = "1000m"
    memory = "2Gi"
  }
  limits = {
    cpu    = "2000m"
    memory = "4Gi"
  }
}

# ============================================================================
# Compliance & Audit
# ============================================================================

# Enable audit logging
enable_audit_logging = true
audit_log_retention_days = 730  # 2 years

# Data residency (for compliance)
data_residency_region = "us-central1"

# Encryption
enable_customer_managed_encryption = true  # Use CMEK for production

# ============================================================================
# Notes
# ============================================================================

# PRODUCTION CRITICAL CHECKLIST:
# [ ] All secrets are stored in Secret Manager (never in .tfvars)
# [ ] Binary authorization is enabled
# [ ] Network policies are configured
# [ ] Audit logging is enabled
# [ ] Budget alerts are configured
# [ ] Disaster recovery plan is tested
# [ ] Multi-region replication is enabled
# [ ] Monitoring and alerting are configured
# [ ] SSL certificates are valid and auto-renewing
# [ ] Security scanning is enabled
