name: OpenTofu Validate

on:
  pull_request:
    paths:
      - 'opentofu/**'
      - '.github/workflows/tofu-*.yml'
  push:
    branches:
      - main
    paths:
      - 'opentofu/**'
      - '.github/workflows/tofu-*.yml'

env:
  TOFU_VERSION: '1.10.7'

jobs:
  validate:
    name: Validate OpenTofu Code
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Check OpenTofu version
        run: tofu version

      - name: Format check
        run: |
          cd opentofu/environments/${{ matrix.environment }}
          tofu fmt -check -recursive

      - name: Initialize OpenTofu
        run: |
          cd opentofu/environments/${{ matrix.environment }}
          # Disable backend for validation (no GCS access in CI)
          if [ -f backend.tf ]; then
            mv backend.tf backend.tf.bak
          fi
          tofu init

      - name: Validate configuration
        run: |
          cd opentofu/environments/${{ matrix.environment }}
          tofu validate

      - name: Restore backend configuration
        if: always()
        run: |
          cd opentofu/environments/${{ matrix.environment }}
          if [ -f backend.tf.bak ]; then
            mv backend.tf.bak backend.tf
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'opentofu/'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  lint:
    name: Lint OpenTofu Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Run tflint
        run: |
          cd terraform
          tflint --init
          tflint --recursive

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate, security-scan, lint]
    if: always()

    steps:
      - name: Check validation results
        run: |
          if [ "${{ needs.validate.result }}" != "success" ]; then
            echo "❌ OpenTofu validation failed"
            exit 1
          fi
          if [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "⚠️ Security scan found issues"
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "⚠️ Linting found issues"
          fi
          echo "✅ All validation checks passed!"
