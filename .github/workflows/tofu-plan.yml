name: OpenTofu Plan

on:
  pull_request:
    paths:
      - 'terraform/**'
    types: [opened, synchronize, reopened]

env:
  TOFU_VERSION: '1.10.7'

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  plan:
    name: Plan Infrastructure Changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, production]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Initialize OpenTofu
        run: |
          cd terraform/environments/${{ matrix.environment }}
          tofu init

      - name: Create execution plan
        id: plan
        run: |
          cd terraform/environments/${{ matrix.environment }}
          tofu plan -no-color -out=tfplan 2>&1 | tee plan.txt
        continue-on-error: true

      - name: Save plan output
        run: |
          cd terraform/environments/${{ matrix.environment }}
          tofu show -no-color tfplan > plan-readable.txt

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tofu-plan-${{ matrix.environment }}
          path: |
            terraform/environments/${{ matrix.environment }}/tfplan
            terraform/environments/${{ matrix.environment }}/plan-readable.txt
          retention-days: 30

      - name: Comment PR with plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: ${{ steps.plan.outputs.stdout }}
        with:
          script: |
            const fs = require('fs');
            const planPath = 'terraform/environments/${{ matrix.environment }}/plan.txt';
            const plan = fs.readFileSync(planPath, 'utf8');

            const output = `### OpenTofu Plan - \`${{ matrix.environment }}\` Environment

            <details><summary>Show Plan</summary>

            \`\`\`hcl
            ${plan}
            \`\`\`

            </details>

            **Pusher**: @${{ github.actor }}
            **Action**: ${{ github.event_name }}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Plan status
        if: steps.plan.outcome == 'failure'
        run: exit 1

  cost-estimate:
    name: Cost Estimation
    runs-on: ubuntu-latest
    needs: plan
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download plan artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tofu-plan-*
          path: plans/

      - name: Install Infracost
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

      - name: Generate cost estimate
        run: |
          for env in dev staging production; do
            if [ -f "plans/tofu-plan-${env}/plan-readable.txt" ]; then
              echo "=== Cost estimate for ${env} ===" >> cost-estimate.txt
              infracost breakdown --path "plans/tofu-plan-${env}/plan-readable.txt" >> cost-estimate.txt || echo "Cost estimation not available" >> cost-estimate.txt
              echo "" >> cost-estimate.txt
            fi
          done

      - name: Comment PR with cost estimate
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const cost = fs.readFileSync('cost-estimate.txt', 'utf8');

            const output = `### ðŸ’° Infrastructure Cost Estimate

            <details><summary>Show Cost Breakdown</summary>

            \`\`\`
            ${cost}
            \`\`\`

            </details>

            *Estimates provided by Infracost*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
