name: OpenTofu Drift Detection

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  TOFU_VERSION: '1.10.7'

permissions:
  contents: read
  issues: write
  id-token: write

jobs:
  detect-drift:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, production]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Initialize OpenTofu
        run: |
          cd opentofu/environments/${{ matrix.environment }}
          tofu init

      - name: Refresh state
        run: |
          cd opentofu/environments/${{ matrix.environment }}
          tofu refresh -no-color 2>&1 | tee refresh.log

      - name: Detect drift
        id: plan
        run: |
          cd opentofu/environments/${{ matrix.environment }}
          tofu plan -detailed-exitcode -no-color 2>&1 | tee drift.log
        continue-on-error: true

      - name: Check for drift
        id: drift
        run: |
          cd opentofu/environments/${{ matrix.environment }}
          if [ ${{ steps.plan.outputs.exitcode }} -eq 2 ]; then
            echo "drift=true" >> $GITHUB_OUTPUT
            echo "âœ… Drift detected in ${{ matrix.environment }}"
          else
            echo "drift=false" >> $GITHUB_OUTPUT
            echo "âœ… No drift detected in ${{ matrix.environment }}"
          fi

      - name: Upload drift report
        if: steps.drift.outputs.drift == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ matrix.environment }}-${{ github.run_number }}
          path: |
            opentofu/environments/${{ matrix.environment }}/drift.log
            opentofu/environments/${{ matrix.environment }}/refresh.log
          retention-days: 30

      - name: Create drift issue
        if: steps.drift.outputs.drift == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const driftLog = fs.readFileSync('opentofu/environments/${{ matrix.environment }}/drift.log', 'utf8');

            const issueTitle = `ðŸ”€ Infrastructure Drift Detected - ${{ matrix.environment }}`;
            const issueBody = `### Drift Detection Alert

            **Environment**: \`${{ matrix.environment }}\`
            **Detected**: ${{ github.event.repository.updated_at }}
            **Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Drift Details

            <details><summary>Show Drift Report</summary>

            \`\`\`hcl
            ${driftLog}
            \`\`\`

            </details>

            ### Recommended Actions

            1. Review the drift report above
            2. Investigate why infrastructure changed outside of OpenTofu
            3. Either:
               - Update OpenTofu configuration to match current state, OR
               - Run \`tofu apply\` to restore infrastructure to desired state
            4. Close this issue once drift is resolved

            ### Priority

            ${{ matrix.environment == 'production' ? 'ðŸ”´ **HIGH** - Production environment affected' : 'ðŸŸ¡ **MEDIUM** - Non-production environment' }}

            ---
            *This issue was automatically created by the drift detection workflow.*
            `;

            // Check if an open drift issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-detection,${{ matrix.environment }}'
            });

            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['drift-detection', 'infrastructure', '${{ matrix.environment }}', 'automated']
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `### New Drift Detected\n\n**Time**: ${{ github.event.repository.updated_at }}\n\n${issueBody}`
              });
            }

  drift-summary:
    name: Drift Detection Summary
    runs-on: ubuntu-latest
    needs: detect-drift
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## ðŸ”€ Daily Drift Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results by Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | ${{ needs.detect-drift.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.detect-drift.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ${{ needs.detect-drift.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Check individual job logs for details.*" >> $GITHUB_STEP_SUMMARY
